<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Map</title>
    <style>
        body{
            font-family:"微软雅黑", Arial;
            font-size:14px;
            background-color:black;
            margin:0px;
            overflow: hidden;
        }
        .load_mask{
            position: fixed;
            top: 0px;
            left: 0px;
            right: 0px;
            bottom: 0px;
            z-index: 1;
            display: none;
        }
        .output{
            position: fixed;
            top: 0px;
            left: 0px;
            right: 0px;
            min-height: 32px;
            background-color: aliceblue;
            text-align: center;
            z-index: 1;
        }
    </style>
    <script src="js/three.min.js" type="text/javascript"></script>
    <script src="js/renderers/CanvasRenderer.js"></script>

    <script src="js/loaders/OBJLoader.js" type="text/javascript"></script>
    <script src="js/loaders/MTLLoader.js" type="text/javascript"></script>

    <script src="js/libs/stats.min.js"></script>
</head>
<body>
    <div class="output" id="output">A,S,D,W控制坦克行走</div>
    <div id="container"></div>
    <script>
        var camera, scene, renderer;
        var stats;
        var armMovement = '';
        var position = {x:0,y:0};
        var tank = '';

        window.onload = function () {
            //load_mask();
            init();
            animate();

            initInput();
        };

        function init() {
            var container;
            container = document.getElementById( 'container' );
            scene = new THREE.Scene();//场景
            //scene.fog = new THREE.Fog(0xffffff,500,600);//雾化效果,以相机距离设置
            //scene.fog = new THREE.FogExp2(0xffffff,0.002);

            camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 600 );//相机
            //camera = new THREE.OrthographicCamera( window.innerWidth / -16, window.innerWidth / 16, window.innerHeight / 16, window.innerHeight / -16);//相机
            //camera.position.set(0,-50,100);
            camera.position.x = 0;
            camera.position.y = -50;
            camera.position.z = 100;
            camera.lookAt(new THREE.Vector3(0,0,0));

            //画辅助线
            var size = 1000, step = 10;
            var geometry = new THREE.Geometry();
            for ( var i = - size; i <= size; i += step ) {
                geometry.vertices.push( new THREE.Vector3( - size, i, 0 ) );
                geometry.vertices.push( new THREE.Vector3(   size, i, 0 ) );
                geometry.vertices.push( new THREE.Vector3( i, - size , 0 ) );
                geometry.vertices.push( new THREE.Vector3( i,   size , 0 ) );
            }
            var material = new THREE.LineBasicMaterial( { color: 0xffffff, opacity: 0.2 } );
            var line = new THREE.LineSegments( geometry, material );
            scene.add( line );


            //加载外部几何体JOSN,Q人物
            var loader = new THREE.JSONLoader();
            loader.load('mesh/20170115_1.json',function (geometry, mat) {
                //alert(mat[0]);
                mesh = new THREE.Mesh(geometry,mat[0]);
                mesh.position.set(-100,0,0);
                mesh.scale.x = 10;
                mesh.scale.y = 10;
                mesh.scale.z = 10;
                mesh.rotation.x = Math.PI/2;
                scene.add(mesh);
                //alert(scene.length);
            });


            /*
            //坦克模型OBJ
            var loader = new THREE.OBJLoader();
            var mloader = new THREE.MTLLoader();
            loader.load('obj/male02.obj', function (geometry) {
                //var material = new THREE.MeshLambertMaterial({color: 0xffffff});
                mloader.load('obj/male02.mtl',function (materi) {
                    alert(materi);

                    geometry.children.forEach(function (child) {
                        if(child.children[0] instanceof THREE.Mesh){
                            child.children[0].material = materi;
                        }
                    });
                    geometry.rotation.x = Math.PI/2;
                    //geometry.scale.set(0.5,0.5,0.5);
                    geometry.scale.set(0.3,0.3,0.3);
                    scene.add(geometry);
                });

            });
            */

            /*
            //城市
            var mtl_loader = new THREE.MTLLoader();
            mtl_loader.setPath("obj/The_City/");
            mtl_loader.load('The_City.mtl',function (materials) {
                materials.preload();
                var obj_loader = new THREE.OBJLoader();
                obj_loader.setMaterials(materials);
                obj_loader.setPath('obj/The_City/');
                obj_loader.load('The_City.obj', function (geometry) {
                    geometry.rotation.x = Math.PI/2;
                    geometry.scale.set(0.1,0.1,0.1);
                    //geometry.scale.set(1,1,1);
                    scene.add(geometry);
                });

            });
            */
            var mtl_loader = new THREE.MTLLoader();
            mtl_loader.setPath("obj/");
            mtl_loader.load('L05_T1.mtl',function (materials) {
                materials.preload();
                var obj_loader = new THREE.OBJLoader();
                obj_loader.setMaterials(materials);
                obj_loader.setPath('obj/');
                obj_loader.load('L05_T1.obj', function (geometry) {
                    geometry.rotation.x = Math.PI/2;
                    geometry.rotation.y = Math.PI;
                    geometry.scale.set(10,10,10);
                    tank = geometry;
                    scene.add(tank);
                });

            });


            //环境光
            var hemiLight = new THREE.HemisphereLight(0xffffff,0x000000,0.6);
            hemiLight.position.set(0,100,1000);
            scene.add(hemiLight);

            /*
            var plight = new THREE.PointLight("#ccffcc");
            plight.distance = 500;
            plight.position.z = 200;
            scene.add(plight);
            */

            stats = new Stats();
            stats.domElement.style.position = 'absolute';
            stats.domElement.style.top = '0px';
            container.appendChild( stats.domElement );

            renderer = new THREE.WebGLRenderer();
            renderer.setPixelRatio( window.devicePixelRatio );
            renderer.setSize( window.innerWidth, window.innerHeight );
            renderer.shadowMap.enabled = true;
            container.appendChild( renderer.domElement );

            window.addEventListener( 'resize', onWindowResize, false );
            //window.addEventListener("")
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize( window.innerWidth, window.innerHeight );
        }

        function loadTexture( path ) {
            var texture = new THREE.Texture( texture_placeholder );
            var material = new THREE.MeshBasicMaterial( { map: texture, overdraw: 0.5 } );
            var image = new Image();
            image.onload = function () {
                texture.image = this;
                texture.needsUpdate = true;
            };
            image.src = path;
            return material;
        }

        function animate() {
            update();
            stats.update();
            requestAnimationFrame( animate );
        }

        var jd = 0;

        function update() {
            /*
            if(load_mask_status[0] != 0 && load_mask_status[0] == load_mask_status[1]){
                if(load_mask_first_load == true){
                    load_mask_first_load = false;
                    add_load_mask();
                }else{
                    mask_update();

                }
            }
            */
            //camera.position.set(-40,-40,100);
            jd += Math.PI/180;
            //x = Math.sin(jd)*-50;
            //y = Math.cos(jd)*-50;
            //document.getElementById("output").innerHTML = x;
            //camera.position.x = Math.sin(jd)*-50;
            //camera.position.y = Math.cos(jd)*-50;
            //canera.rotation.x = Math.sin(jd)*-50;
            //camera.rotation.y = Math.cos(jd)*-50;
            //camera.rotation.y = Math.sin(jd)*-50;
            //camera.rotation.z += Math.PI/180;

            if(tank != ''){
                if(position.x == 0){
                    if(position.y > 0){
                        tank.rotation.y = 0;
                    }
                    if(position.y < 0){
                        tank.rotation.y = Math.PI;
                    }
                    tank.position.y += position.y;
                }
                if(position.y == 0){
                    if(position.x > 0){
                        tank.rotation.y = -Math.PI/2;
                    }
                    if(position.x < 0){
                        tank.rotation.y = Math.PI/2;
                    }
                    tank.position.x += position.x;
                }
                if(position.x > 0){
                    if(position.y > 0){
                        tank.rotation.y = -Math.PI * 45/180;
                    }
                    if(position.y < 0){
                        tank.rotation.y = -Math.PI * 135/180;
                    }
                }

                if(position.x < 0){
                    if(position.y > 0){
                        tank.rotation.y = Math.PI * 45/180;
                    }
                    if(position.y < 0) {
                        tank.rotation.y = Math.PI * 135 / 180;
                    }
                }

                if(position.x != 0 && position.y != 0){
                    tank.position.x += position.x*Math.sin(Math.PI/4);
                    tank.position.y += position.y*Math.cos(Math.PI/4);
                }



                document.getElementById("output").innerHTML = tank.position.x + "/" + tank.position.y;
                camera.position.set(tank.position.x,tank.position.y -50,100);
                camera.lookAt(new THREE.Vector3(tank.position.x,tank.position.y,0));
            }
            renderer.render( scene, camera );
        }

        //把加载页面放到场景里
        function add_load_mask() {
            for(var key in mask_obj){
                mask_obj[key].texture_update();
                scene.add(mask_obj[key].obj);

            }
        }

        function initInput() {
            window.addEventListener( 'keydown', function( event ) {
                switch ( event.keyCode ) {
                    case 65://a A
                        //armMovement = 65;
                        position.x = -1;
                        break;
                    case 66://b B
                        break;
                    case 67://c C
                        break;
                    case 68://d D
                        position.x = 1;
                        break;
                    case 69://e E EuroSign
                        break;
                    case 70://f F
                        break;
                    case 71://g G
                        break;
                    case 72://h H
                        break;
                    case 73://i I
                        break;
                    case 74://j J
                        break;
                    case 75://k K
                        break;
                    case 76://l L
                        break;
                    case 77://m M mu
                        break;
                    case 78://n N
                        break;
                    case 79://o O
                        break;
                    case 80://p P
                        break;
                    case 81://q Q at
                        break;
                    case 82://r R
                        break;
                    case 83://s S
                        position.y = -1;
                        break;
                    case 84://t T
                        break;
                    case 85://u U
                        break;
                    case 86://v V
                        break;
                    case 87://w W
                        position.y = 1;
                        break;
                    case 88://x X
                        break;
                    case 89://y Y
                        break;
                    case 90://z Z
                        break;
                }
            }, false );

            window.addEventListener( 'keyup', function( event ) {
                //armMovement = '';
                //position.x = 0;
                //position.y = 0;
                switch ( event.keyCode ) {
                    case 65://a A
                        position.x = 0;
                        break;
                    case 66://b B
                        break;
                    case 67://c C
                        break;
                    case 68://d D
                        position.x = 0;
                        break;
                    case 69://e E EuroSign
                        break;
                    case 70://f F
                        break;
                    case 71://g G
                        break;
                    case 72://h H
                        break;
                    case 73://i I
                        break;
                    case 74://j J
                        break;
                    case 75://k K
                        break;
                    case 76://l L
                        break;
                    case 77://m M mu
                        break;
                    case 78://n N
                        break;
                    case 79://o O
                        break;
                    case 80://p P
                        break;
                    case 81://q Q at
                        break;
                    case 82://r R
                        break;
                    case 83://s S
                        position.y = 0;
                        break;
                    case 84://t T
                        break;
                    case 85://u U
                        break;
                    case 86://v V
                        break;
                    case 87://w W
                        position.y = 0;
                        break;
                    case 88://x X
                        break;
                    case 89://y Y
                        break;
                    case 90://z Z
                        break;
                }
            }, false );

        }
    </script>
</body>
</html>